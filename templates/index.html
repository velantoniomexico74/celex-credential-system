<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Captura de Calificaciones</title>
    <style>
        body { font-family: Arial; }
        table { border-collapse: collapse; width: 70%; margin: 20px auto; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        .btn { padding: 8px 12px; margin: 8px; cursor: pointer; display:inline-block; text-decoration:none; background:#eee; border-radius:4px; color:black; }
    </style>
</head>
<body>

<h2 style="text-align:center">Captura de Calificaciones</h2>

<table>
    <tr>
        <th>Alumno</th>
        <th>Calificación (0-100)</th>
    </tr>

    {% for student in students %}
    <tr>
        <td>{{ student[1] }}</td>
        <td>
            <input type="number" min="0" max="100" class="grade-input"
                   data-id="{{ student[0] }}"
                   value="{{ student[2] }}"
                   style="width:90px;">
        </td>
    </tr>
    {% endfor %}
</table>

<div style="text-align:center; margin-top:16px;">
    <button class="btn" onclick="saveGrades()">Guardar</button>
    <a class="btn" href="/export/excel">Exportar a Excel</a>
    <a class="btn" href="/print" target="_blank">Imprimir</a>
    <a class="btn" href="/upload-students">Cargar alumnos desde Excel</a>
</div>

<script>
function saveGrades() {
    let rows = document.querySelectorAll(".grade-input");
    let data = [];

    for (let r of rows) {
        let grade = r.value;
        if (grade === "") grade = null;
        if (grade !== null) {
            let gnum = Number(grade);
            if (isNaN(gnum) || gnum < 0 || gnum > 100) {
                alert("Las calificaciones deben ser números entre 0 y 100.");
                return;
            }
        }
        data.push({ id: r.getAttribute("data-id"), grade: grade });
    }

    fetch("/save", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
    })
    .then(r => {
        if (!r.ok) return r.text().then(t => { throw new Error(t || 'Error al guardar'); });
        return r.text();
    })
    .then(_ => alert("Calificaciones guardadas correctamente."))
    .catch(e => alert("Error: " + e.message));
}
</script>

</body>
</html>
