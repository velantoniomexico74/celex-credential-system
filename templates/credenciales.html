<!DOCTYPE html>
<html>
<head>
<title>Credenciales CELEX</title>

<script>
function iniciarProceso(form, mensajeId) {

    const mensaje = document.getElementById(mensajeId);
    const boton = form.querySelector("button[type='submit']");

    // Mostrar mensaje inicial
    mensaje.style.display = "block";
    mensaje.innerHTML = "⏳ Generación iniciada... espere por favor.";

    // Deshabilitar botón
    boton.dataset.original = boton.innerText;
    boton.disabled = true;
    boton.innerText = "Procesando...";

    // Detectar cuando el navegador vuelve a foco (después de descarga)
    function finalizarProceso() {
        boton.disabled = false;
        boton.innerText = boton.dataset.original;
        mensaje.innerHTML = "✔ Generación completada.";

        window.removeEventListener("focus", finalizarProceso);
    }

    window.addEventListener("focus", finalizarProceso);
}

// Limpieza automática si el usuario hace F5
window.addEventListener("pageshow", function () {

    document.querySelectorAll(".mensaje").forEach(function (el) {
        el.style.display = "none";
        el.innerHTML = "";
    });

    document.querySelectorAll("button[type='submit']").forEach(function (btn) {
        btn.disabled = false;
        if (btn.dataset.original) {
            btn.innerText = btn.dataset.original;
        }
    });

});
</script>

<style>
body { 
    font-family: Arial; 
    background:#f4f4f4; 
    margin:0; 
}

.header {
    background:#6A0032;
    color:white;
    text-align:center;
    padding:25px;
}

.container {
    display:flex;
    justify-content:center;
    gap:40px;
    margin:50px;
}

.section {
    width:450px;
    background:white;
    padding:25px;
    border-radius:12px;
    box-shadow:0px 6px 15px rgba(0,0,0,0.2);
}

h3 {
    color:#6A0032;
    text-align:center;
}

button {
    width:100%;
    padding:12px;
    background:#6A0032;
    color:white;
    border:none;
    border-radius:8px;
    margin-top:15px;
    cursor:pointer;
}

button:hover { 
    background:#4E0024; 
}

input { 
    width:100%; 
    padding:8px; 
    margin-top:10px; 
}

.mensaje {
    display:none;
    margin-top:15px;
    font-weight:bold;
    color:#6A0032;
}

.footer {
    background:#6A0032;
    color:white;
    text-align:center;
    padding:15px;
    margin-top:50px;
}
</style>
</head>

<body>

<div class="header">
    <h1>Generación y Reimpresión de Credenciales</h1>
</div>

<div class="container">

    <!-- GENERACIÓN MASIVA -->
    <div class="section">
        <h3>Generación Masiva</h3>

        <form method="POST" enctype="multipart/form-data"
              onsubmit="iniciarProceso(this, 'msgGen')">
            
            <label>Excel:</label>
            <input type="file" name="excel" required>

            <label>Fotos:</label>
            <input type="file" name="fotos" multiple required>

            <button type="submit">
                Generar Credenciales
            </button>

            <div id="msgGen" class="mensaje"></div>

        </form>
    </div>


    <!-- BOTÓN VOLVER -->
    <div style="display:flex; align-items:center;">
        <a href="/dashboard">
            <button style="
                width:200px;
                background:#C9A227;
                color:#6A0032;
            ">
                ← Volver al menú
            </button>
        </a>
    </div>


    <!-- REIMPRESIÓN -->
    <div class="section">
        <h3>Reimpresión Individual</h3>

        {% if error %}
            <p style="color:red;">{{ error }}</p>
        {% endif %}

        <form method="POST"
              onsubmit="iniciarProceso(this, 'msgReimp')">

            <label>Matrícula:</label>
            <input type="text" name="matricula" required>

            <button type="submit">
                Reimprimir Credencial
            </button>

            <div id="msgReimp" class="mensaje"></div>

        </form>
    </div>

</div>

<div class="footer">
    Ing. JAVS-UDI
</div>

</body>
</html>
